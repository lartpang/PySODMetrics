# GitHub Actions 自动构建文档

本项目使用 GitHub Actions 自动构建和部署 Sphinx 文档到 GitHub Pages。

## 工作流程

当代码推送到主分支时，GitHub Actions 会自动：

1. 检出代码
2. 安装 Python 和依赖
3. 构建 Sphinx 文档
4. 部署到 `gh-pages` 分支
5. GitHub Pages 自动发布

## 触发条件

文档自动构建会在以下情况触发：

- 推送到 `main` 或 `master` 分支
- 修改了以下文件：
  - `deploy/` 目录中的任何文件（文档源）
  - `py_sod_metrics/` 目录中的任何文件（API 文档源）
  - `.github/workflows/docs.yml` 工作流文件

## 手动触发

如果需要手动触发文档构建：

1. 进入 GitHub 仓库页面
2. 点击 "Actions" 标签
3. 选择 "Build and Deploy Documentation" 工作流
4. 点击 "Run workflow" 按钮

## GitHub Pages 设置

### 首次设置

1. 进入仓库的 Settings → Pages
2. Source 选择：
   - **Branch**: `gh-pages`
   - **Folder**: `/ (root)`
3. 保存设置

### 访问文档

文档发布后，可以通过以下地址访问：

```
https://<your-username>.github.io/PySODMetrics/
```

## 工作流文件

工作流文件位于：`.github/workflows/docs.yml`

### 主要步骤

1. **Checkout repository** - 检出代码
2. **Set up Python** - 安装 Python 3.10
3. **Install dependencies** - 安装 Sphinx 和主题
4. **Build documentation** - 构建 HTML 文档
5. **Deploy to GitHub Pages** - 部署到 gh-pages 分支

## 本地构建 vs 自动构建

### 本地构建

仍然可以在本地构建文档进行预览：

```bash
cd deploy
make html  # Linux/Mac
make.bat html  # Windows
```

本地构建的结果在 `docs/` 目录，但**不需要**提交这些文件到 Git。

### 自动构建

GitHub Actions 会在云端自动构建，无需本地生成 HTML 文件。

## Git 工作流建议

### 方案 A：不提交 docs/ 目录（推荐）

将 `docs/` 添加到 `.gitignore`：

```gitignore
# Build output (generated by GitHub Actions)
docs/
```

**优点**：
- 仓库更干净
- 避免不必要的文件冲突
- 减小仓库大小

**缺点**：
- 必须依赖 GitHub Actions

### 方案 B：提交 docs/ 目录

保留 `docs/` 在 Git 中作为备份。

**优点**：
- 即使 Actions 失败也有备份
- 可以查看文档历史

**缺点**：
- 每次推送都会有大量文件变更
- 容易产生合并冲突

## 故障排查

### Actions 失败

如果 GitHub Actions 失败，检查：

1. **Permission 错误**：确保仓库设置中启用了 Actions 的写权限
   - Settings → Actions → General → Workflow permissions
   - 选择 "Read and write permissions"

2. **分支保护**：确保 `gh-pages` 分支没有保护规则阻止 Actions

3. **依赖安装失败**：检查 `pyproject.toml` 中的依赖是否正确

### Pages 未更新

如果文档未更新：

1. 检查 Actions 是否成功运行
2. 确认 GitHub Pages 设置正确（来源为 `gh-pages` 分支）
3. GitHub Pages 部署可能需要几分钟时间

## 自定义配置

### 修改触发条件

编辑 `.github/workflows/docs.yml`：

```yaml
on:
  push:
    branches:
      - main  # 修改为你的主分支名
    paths:
      - 'deploy/**'  # 添加或删除路径
```

### 修改 Python 版本

```yaml
- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: '3.11'  # 修改版本
```

### 添加额外依赖

```yaml
- name: Install dependencies
  run: |
    pip install sphinx sphinx-rtd-theme
    pip install your-extra-dependency
    pip install -e .
```

## 监控构建状态

添加徽章到 README.md：

```markdown
[![Documentation Status](https://github.com/<username>/PySODMetrics/workflows/Build%20and%20Deploy%20Documentation/badge.svg)](https://github.com/<username>/PySODMetrics/actions)
```

## 注意事项

- 确保 `deploy/conf.py` 中的配置正确
- 文档构建警告不会导致 Actions 失败（除非是 ERROR）
- `gh-pages` 分支会被自动创建和管理，无需手动操作
- 每次成功构建会完全替换 `gh-pages` 分支的内容
