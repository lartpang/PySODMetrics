name: Publish Python ğŸ distribution ğŸ“¦ to PyPI

# è§¦å‘æ¡ä»¶ï¼šå½“æ‰‹åŠ¨åˆ›å»ºReleaseæ—¶è§¦å‘ï¼ˆåŒ…æ‹¬è‰ç¨¿å‘å¸ƒè½¬æ­£å¼å‘å¸ƒï¼‰
on:
  release:
    types: [created]

jobs:
  build:
    name: Build distribution ğŸ“¦
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»“åº“ä»£ç 
    - uses: actions/checkout@v4
      with:
        # ç¦ç”¨å‡­æ®æŒä¹…åŒ–ï¼ˆé¿å…æƒé™æ®‹ç•™ï¼‰
        persist-credentials: false

    # 2. è®¾ç½®Pythonç¯å¢ƒï¼ˆä½¿ç”¨æœ€æ–°çš„3.xç‰ˆæœ¬ï¼‰
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    # 3. å®‰è£…Pythonæ„å»ºå·¥å…·
    - name: Install pypa/build
      run: python3 -m pip install build --user

    # 4. æ„å»ºäºŒè¿›åˆ¶wheelå’Œæºä»£ç tarball
    - name: Build a binary wheel and a source tarball
      run: python3 -m build

    # 5. ä¿å­˜æ„å»ºäº§ç‰©ï¼ˆdistç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 1 # 1 å¤©ååˆ é™¤ artifact

  publish-to-pypi:
    name: Publish Python ğŸ distribution ğŸ“¦ to PyPI
    # æ¡ä»¶åˆ¤æ–­ï¼šä»…å½“æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶æ‰§è¡Œ
    # 1. äº‹ä»¶ç±»å‹ä¸ºReleaseåˆ›å»º
    # 2. æ ‡ç­¾ä»¥refs/tags/vå¼€å¤´ï¼ˆå³vX.Y.Zæ ¼å¼ï¼‰
    # 3. æ ‡ç­¾åŒ…å«ç‚¹å·ï¼ˆç¡®ä¿ç‰ˆæœ¬åˆ†éš”ç¬¦å­˜åœ¨ï¼‰
    # 4. æ’é™¤åŒ…å«è¿ç»­ç‚¹å·çš„å¼‚å¸¸æ ‡ç­¾ï¼ˆå¦‚v1..2ï¼‰
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '.')
    needs: [build]  # ä¾èµ–buildä½œä¸šçš„å®Œæˆ
    runs-on: ubuntu-latest
    # ç¯å¢ƒé…ç½®
    environment:
      name: pypi
      url: https://pypi.org/p/pysodmetrics
    permissions:
      # å¿…é¡»é…ç½®OIDCæƒé™ç”¨äºå¯ä¿¡å‘å¸ƒ
      id-token: write

    steps:
    # 6. ä¸‹è½½ä¹‹å‰æ„å»ºé˜¶æ®µä¿å­˜çš„äº§ç‰©
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    # 7. å‘å¸ƒåˆ°PyPI
    - name: Publish distribution ğŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1